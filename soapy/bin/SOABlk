#!/usr/bin/env python
"""
TODO: 
 * finish SOA timing/confirm
 * write to file
 * ID split timing


1. More training trials
The thought was we could do maybe 2 learning blocks at the start while acquiring BOLD, then a whole bunch of extra blocks (with faster timing) while they do the mprage (~6-8 min?), then 2 more blocks with fmri.  That way, we’d see the start and end of the learning phase, but still get them a lot of training trials.

2. Block design for SOA/DD phases, with variable # of devaluations
Rather than the current event related design, which requires the variable and sometimes long ISIs, the thought was to do blocks of trials here with the timing matched to what we did behaviorally.  On top of that, we were thinking of varying how many cues are devalued in a given block, i.e., maybe 0, 2 or 4 (of 6)  This should produce variation among blocks in how many habitual responses people make due to task contrasts, as well as parametric contrasts within a devaluation size based on performance variability.  So, we’d want to repeat each block a bunch of times.  

We should discuss specific timing, but my thought was to aim for 16-20 min for each of DD/SOA.  If we did blocks of 1:20, with 0:40 OFF period in between, we could do something like 
- 2 blocks with 0 devaluations (this is kind of a silly one just for a control, so 2 blocks is probably enough?)
- 4 blocks with 2 cues devalued
- 4 blocks with 4 cues devalued

With OFF periods, that would be 20 min… maybe we could split it into 2 10-minute runs, each with 1x0 devaluated, 2x2, 2x4.
"""

# q to quit at any time?
from psychopy.preferences import prefs
prefs.general['shutdownKey'] = 'q'

import sys
import os
from datetime import datetime
from numpy import random
from psychopy.gui import Dlg, DlgFromDict
from typing import Optional, List, Tuple, Dict
from soapy.task_types import PhaseType, TrialType, TimeTypes, TaskTime, Direction, TaskDur
from soapy.box import Box
from soapy.instruct import show_instruction
from soapy.info import FabFruitInfo
from soapy.task import FabFruitTask, core, event
from soapy.lncdtasks import wait_for_scanner, wait_until, Filepath, first_key
from soapy import DEFAULT_PHASES, image_path, read_img_list, timing_path, ENDDUR
from soapy.seeded import pick_seed, single_phase, update_boxes, mkdir_seed
from soapy.gui import ymd, SOADlg, DlgInfo
from soapy.logstdout import default_logfile
from soapy.block import ID_blk, slips_blk

# save dir/files along side this script
os.chdir(os.path.dirname(os.path.realpath(__file__)))

# 5 seconds to take in the grid
# 2 seconds until SOA/DD is assumed pass
# 2 seconds to see the score at the end of every 12 (6 blocks twice)
# 1 second for SOA/DD iti
DURS = {'score': 2,
        'grid': 5,
        'timeout': 2,
        'fbk': 1,
        'iti': 1,
        'OFF': 40,}
MPRAGE_DUR: TaskDur = 6.4*60

info = {'id': '1', #sys.argv[1],
        'start': 'ID',# sys.argv[2],
        'date': ymd(),
        'FullScreen': False,
        'Instructions': False,
        'OnlyOne': True,
        'doit': len(sys.argv) > 3,
        'seed': 0}

SEQUENCE = ['ID_start','ID_mprage','ID_end', 'OD', 'SOA','DD']
def main(argv, info={}):
    dlg = SOADlg()
    dlg.data = [
        DlgInfo('id', info.get('id', 1000)),
        DlgInfo('date', ymd(), isfixed=True),
        DlgInfo('FullScreen', info.get('FullScreen', True)),
        DlgInfo('run', info.get('run', SEQUENCE[0]), SEQUENCE),
        DlgInfo('seed', info.get('seed',0)),]
    info = dlg.set_data()


    #setup_outdir(info)
    #info['outdir'] = '/tmp/soamix'
    #info['seed'] = mkdir_seed(info['outdir'], info['seed'])
    default_logfile(info['outdir'])


    # get box info
    # and make sure it matches directory
    seed = random.default_rng(info['seed'])
    ffi = FabFruitInfo(seed=seed, alwaysTiming=False)
    ffi.set_names(read_img_list('fruits'))
    ffi = update_boxes(ffi, 'fruits', info['outdir'])

    from psychopy.visual import Window
    if info.get('FullScreen',False):
        win = Window() 
    else:
        win = Window([800, 600]) #, screen=1)
    task = FabFruitTask(win, ffi, timing_method=TimeTypes.block)



    if info['run'] in ['ID_start', 'ID_end']:
        print("Not implemented yet!")
    elif info['run'] == 'ID_mprage':
        ID_blk(task, MPRAGE_DUR, DURS, seed)
    elif info['run'] == 'OD':
        print("Not implemented yet!")
    elif info['run'] in ['SOA', 'DD']:
        phase=PhaseType[info['run']]
        slips_blk(task, DURS, seed, phase=phase)
    win.close()
    return info

if __name__ == "__main__":
    info = main(sys.argv)
    last_run = info.get('run',SEQUENCE[0])
    while last_run != SEQUENCE[-1]:
        cur_idx = SEQUENCE.index(last_run) 
        info['run'] = SEQUENCE[cur_idx+1]
        info = main(sys.argv)
        last_run = info.get('run',SEQUENCE[0])

